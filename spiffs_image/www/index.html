<!--
CTAG TBD >>to be determined<< is an open source eurorack synthesizer module.

A project conceived within the Creative Technologies Arbeitsgruppe of
Kiel University of Applied Sciences: https://www.creative-technologies.de

(c) 2020 by Robert Manzke. All rights reserved.

The CTAG TBD software is licensed under the GNU General Public License
(GPL 3.0), available here: https://www.gnu.org/licenses/gpl-3.0.txt

The CTAG TBD hardware design is released under the Creative Commons
Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0).
Details here: https://creativecommons.org/licenses/by-nc-sa/4.0/

CTAG TBD is provided "as is" without any express or implied warranties.

License and copyright details for specific submodules are included in their
respective component folders / files if different from this license.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="-1"/>
    <link rel="stylesheet" href="css/onsenui-core.min.css">
    <link rel="stylesheet" href="css/onsen-css-c.min.css">
    <script src="js/onsenui.min.js"></script>
    <script src="js/jquery-3.4.1.min.js"></script>
    <script src="js/ajaxq.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webmidi"></script>
    <title>CTAG-TBD</title>
</head>
<body>
<ons-navigator swipeable id="myNavigator" page="main.html"></ons-navigator>
</ons-navigator>
<script>
    // Utils
    function setCookie(name,value,days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "")  + expires + "; path=/";
    }
    function getCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i=0;i < ca.length;i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }
    function eraseCookie(name) {
        document.cookie = name +'=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
    }
    // Midi stuff
    if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess({
            sysex: false
        }).then( m =>{
                // get input devices and store in global object
                window.midiCtrl = {};
                window.midiCtrl.devices = m;
                // check if cookie for settings exist and select current item if device exists
                let actMidiInDevID = getCookie('midi-in');
                window.midiCtrl.actMidiInDevID = 0;
                if(actMidiInDevID){
                    for(let i of midiCtrl.devices.inputs.values()){
                        if(i.id == actMidiInDevID){
                            window.midiCtrl.actMidiInDevID = actMidiInDevID;
                            window.midiCtrl.actMidiInDev = i;
                            break;
                        }
                    }
                }
                // not found?
                if(window.midiCtrl.actMidiInDevID == 0){
                    setCookie('midi-in', '0', 365);
                }else{// otherwise register handler
                    window.midiCtrl.actMidiInDev.onmidimessage = processMidiEvent;
                }
            }
            , (err) => {
                console.log(err);
            });
    } else {
        console.warn("No MIDI support in your browser");
    }
    function processMidiEvent( event ) {
        console.log(event);
    }
</script>
</body>
</html>